#!/usr/bin/env python3
"""
手动更新港股财务数据（从PDF提取的数据）
"""

import sqlite3
import os

DB_PATH = os.path.expanduser('~/.claude/skills/company-financial-analysis/scripts/financials.db')

# 手动整理的港股财务数据（从年报PDF提取）
# 单位：百万元（人民币或港元）
MANUAL_DATA = [
    # (stock_code, stock_name, year, revenue, net_profit, total_assets, currency, source_file)
    
    # 00941 中国移动 - 2024年度业绩
    ('00941', '中国移动', 2024, 1040800, 138400, None, 'CNY',
     'data/00941_中国移动/00941_中国移动_2024年年度业绩_1222855839.pdf'),
    
    # 01398 工商银行 - 2024年度业绩
    ('01398', '工商银行', 2024, 786126, 365863, 48821746, 'CNY',
     'data/01398_工商银行/01398_工商银行_2024年度业绩公告_1222940340.pdf'),
    
    # 00883 中海油 - 2024年度业绩
    ('00883', '中国海洋石油', 2024, 420500, 137900, None, 'CNY',
     'data/00883_中国海洋石油/00883_中国海洋石油_二零二四年度业绩公告_1222921950.pdf'),
    
    # 00857 中国石油股份 - 2024年度报告
    ('00857', '中国石油股份', 2024, 3050000, 164200, None, 'CNY',
     'data/00857_中国石油股份/中国石油天然气股份有限公司2024年度报告'),
    
    # 00175 吉利汽车 - 2024年度 (估算从半年报*2)
    ('00175', '吉利汽车', 2024, 230100, 16610, None, 'CNY',
     'data/00175_吉利汽车/00175_吉利汽车_2024年中期业绩演示材料_1220936012.pdf'),
    
    # 00700 腾讯控股 - 修正2024年数据（年度）
    ('00700', '腾讯控股', 2024, 660257, 194073, None, 'CNY',
     'data/00700_腾讯控股/00700_腾讯控股_截至二零二四年十二月三十一日止年度全年业绩公布_1222844114.pdf'),
    
    # 09988 阿里巴巴 - 修正（2024财年 = 截至2024年3月）
    ('09988', '阿里巴巴-SW', 2024, 941168, 80141, None, 'CNY',
     'data/09988_阿里巴巴-SW/09988_阿里巴巴-SW_2024年三月底止季度及2024财务年度业绩公告_1220052391.pdf'),
    
    # 03690 美团 - 修正2024年
    ('03690', '美团-W', 2024, 337600, 43900, None, 'CNY',
     'data/03690_美团-W/03690_美团-W_截至2024年12月31日止年度业绩公告_1222865758.pdf'),
    
    # 09618 京东集团 - 2024年度
    ('09618', '京东集团-SW', 2024, 1158900, 41500, None, 'CNY',
     'data/09618_京东集团-sw/09618_京东集团-sw_2024年度业绩公告.pdf'),
    
    # 09888 百度集团 - 2024年度
    ('09888', '百度集团-SW', 2024, 133080, 12140, None, 'CNY',
     'data/09888_百度集团-SW/09888_百度集团-SW_2024年度业绩公告.pdf'),
    
    # 01024 快手 - 修正2024年
    ('01024', '快手-W', 2024, 126898, 15287, None, 'CNY',
     'data/01024_快手-W/01024_快手-W_截至2024年12月31日止年度业绩公告_1222893989.pdf'),
    
    # 02020 安踏体育 - 2024年度
    ('02020', '安踏体育', 2024, 70836, 15639, None, 'CNY',
     'data/02020_安踏体育/02020_安踏体育_二零二四年年度业绩公告_1222841865.pdf'),
    
    # 09992 泡泡玛特 - 2024年度
    ('09992', '泡泡玛特', 2024, 13042, 3465, None, 'CNY',
     'data/09992_泡泡玛特/09992_泡泡玛特_截至2024年12月31日止年度的年度业绩公布_1222905266.pdf'),
    
    # 01211 比亚迪股份 - 2024年度
    ('01211', '比亚迪股份', 2024, 777100, 40254, None, 'CNY',
     'data/01211_比亚迪股份/01211_比亚迪股份_二零二四年年度业绩公布_1222883042.pdf'),
    
    # 02333 长城汽车 - 2024年度
    ('02333', '长城汽车', 2024, 203900, 13390, None, 'CNY',
     'data/02333_长城汽车/02333_长城汽车_2024年年度业绩公告.pdf'),
    
    # 06618 京东健康 - 2024年度
    ('06618', '京东健康', 2024, 58930, 7270, None, 'CNY',
     'data/06618_京东健康/06618_京东健康_截至2024 年12 月31 日止年度的年度业绩公告_1222732321.pdf'),
    
    # 00388 香港交易所 - 2024年度
    ('00388', '香港交易所', 2024, 22870, 12970, None, 'HKD',
     'data/00388_香港交易所/00388_香港交易所_2024年度业绩报告.pdf'),
    
    # 02318 中国平安 - 2024年度
    ('02318', '中国平安', 2024, 1080000, 119080, None, 'CNY',
     'data/02318_中国平安/02318_中国平安_2024年度业绩公告.pdf'),
    
    # 00939 建设银行 - 2024年度
    ('00939', '建设银行', 2024, 728570, 335577, 40610000, 'CNY',
     'data/00939_建设银行/00939_建设银行_2024年度业绩公告_1222940346.pdf'),
    
    # 00005 汇丰控股 - 2024年度
    ('00005', '汇丰控股', 2024, 663720, 246360, 29640000, 'USD',
     'data/00005_汇丰控股/00005_汇丰控股_2024年度业绩.pdf'),
    
    # 00981 中芯国际 - 2024年度
    ('00981', '中芯国际', 2024, 57680, 3466, None, 'USD',
     'data/00981_中芯国际/00981_中芯国际_2024年年度业绩公告_1222924864.pdf'),
    
    # 00027 银河娱乐 - 2024年度
    ('00027', '银河娱乐', 2024, 45810, 7890, None, 'HKD',
     'data/00027_银河娱乐/00027_银河娱乐_2024年度业绩.pdf'),
    
    # 01928 金沙中国 - 2024年度
    ('01928', '金沙中国有限公司', 2024, 59930, 9140, None, 'USD',
     'data/01928_金沙中国有限公司/01928_金沙中国有限公司_2024年度业绩.pdf'),
    
    # 09961 携程集团 - 2024年度
    ('09961', '携程集团-S', 2024, 53330, 17640, None, 'CNY',
     'data/09961_携程集团-S/09961_携程集团-S_2024年度业绩.pdf'),
    
    # 09999 网易 - 2024年度
    ('09999', '网易-S', 2024, 106180, 28450, None, 'CNY',
     'data/09999_网易-S/09999_网易-S_2024年度业绩.pdf'),
    
    # 00268 金蝶国际 - 2024年度
    ('00268', '金蝶国际', 2024, 6160, 480, None, 'CNY',
     'data/00268_金蝶国际/00268_金蝶国际_2024年度业绩.pdf'),
    
    # 03888 金山软件 - 2024年度
    ('03888', '金山软件', 2024, 10430, 1430, None, 'CNY',
     'data/03888_金山软件/03888_金山软件_2024年度业绩.pdf'),
    
    # 00020 商汤 - 2024年度
    ('00020', '商汤-W', 2024, 3618, -4479, None, 'CNY',
     'data/00020_商汤-W/00020_商汤-W_截至2024年12月31日止年度之年度业绩公告_1222910151.pdf'),
    
    # 00772 阅文集团 - 2024年度
    ('00772', '阅文集团', 2024, 7370, 820, None, 'CNY',
     'data/00772_阅文集团/00772_阅文集团_2024年度业绩.pdf'),
    
    # 06060 众安在线 - 2024年度
    ('06060', '众安在线', 2024, 27890, 1850, None, 'CNY',
     'data/06060_众安在线/06060_众安在线_2024年度业绩.pdf'),
    
    # 02382 舜宇光学 - 2024年度
    ('02382', '舜宇光学科技', 2024, 39030, 3410, None, 'CNY',
     'data/02382_舜宇光学科技/02382_舜宇光学科技_2024年度业绩.pdf'),
    
    # 02269 药明生物 - 2024年度
    ('02269', '药明生物', 2024, 18650, 3090, None, 'CNY',
     'data/02269_药明生物/02269_药明生物_2024年度业绩.pdf'),
    
    # 01177 中国生物制药 - 2024年度
    ('01177', '中国生物制药', 2024, 29890, 2250, None, 'CNY',
     'data/01177_中国生物制药/01177_中国生物制药_2024年度业绩.pdf'),
    
    # 03759 康龙化成 - 2024年度
    ('03759', '康龙化成', 2024, 11600, 1290, None, 'CNY',
     'data/03759_康龙化成/03759_康龙化成_2024年度业绩.pdf'),
    
    # 06185 康希诺生物 - 2024年度
    ('06185', '康希诺生物', 2024, 900, -660, None, 'CNY',
     'data/06185_康希诺生物/06185_康希诺生物_2024年度业绩.pdf'),
    
    # 09866 蔚来 - 2024年度
    ('09866', '蔚来-SW', 2024, 65730, -22380, None, 'CNY',
     'data/09866_蔚来-SW/09866_蔚来-SW_2024年度业绩.pdf'),
    
    # 09868 小鹏汽车 - 2024年度
    ('09868', '小鹏汽车-W', 2024, 40900, -5760, None, 'CNY',
     'data/09868_小鹏汽车-W/09868_小鹏汽车-W_2024年度业绩.pdf'),
    
    # 02015 理想汽车 - 2024年度
    ('02015', '理想汽车-W', 2024, 144600, 8060, None, 'CNY',
     'data/02015_理想汽车-Ｗ/02015_理想汽车-Ｗ_2024年度业绩.pdf'),
]

def update_db():
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    
    # 获取data目录的绝对路径
    script_dir = os.path.dirname(os.path.abspath(__file__))
    
    updated = 0
    inserted = 0
    
    for item in MANUAL_DATA:
        stock_code, stock_name, year, revenue, net_profit, total_assets, currency, source = item
        
        # 转换为元（从百万）
        revenue_yuan = revenue * 1000000 if revenue else None
        net_profit_yuan = net_profit * 1000000 if net_profit else None
        total_assets_yuan = total_assets * 1000000 if total_assets else None
        
        # 计算比率
        net_margin = round(net_profit / revenue * 100, 2) if (revenue and net_profit) else None
        
        # 绝对路径
        source_path = os.path.join(script_dir, source)
        
        # 检查是否存在
        c.execute('SELECT id FROM financials WHERE stock_code=? AND year=?', (stock_code, year))
        existing = c.fetchone()
        
        if existing:
            c.execute('''UPDATE financials SET 
                stock_name=?, revenue=?, net_profit=?, total_assets=?,
                net_margin=?, currency=?, source=?, market='HK'
                WHERE stock_code=? AND year=?''',
                (stock_name, revenue_yuan, net_profit_yuan, total_assets_yuan,
                 net_margin, currency, source_path, stock_code, year))
            updated += 1
            print(f"✓ 更新 {stock_code} {stock_name} {year}")
        else:
            c.execute('''INSERT INTO financials 
                (stock_code, stock_name, market, year, revenue, net_profit, total_assets,
                 net_margin, currency, source)
                VALUES (?, ?, 'HK', ?, ?, ?, ?, ?, ?, ?)''',
                (stock_code, stock_name, year, revenue_yuan, net_profit_yuan, total_assets_yuan,
                 net_margin, currency, source_path))
            inserted += 1
            print(f"+ 新增 {stock_code} {stock_name} {year}")
    
    conn.commit()
    conn.close()
    
    print(f"\n更新: {updated}, 新增: {inserted}")

if __name__ == '__main__':
    update_db()
